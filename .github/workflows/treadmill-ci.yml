# Licensed under the Apache License, Version 2.0 or the MIT License.
# SPDX-License-Identifier: Apache-2.0 OR MIT
# Copyright Tock Contributors 2023.

# This workflow contains all Treadmill-based hardware CI jobs.

name: treadmill-ci
env:
  TERM: xterm # Makes tput work in actions output

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
  push: # Run CI for all branches except GitHub merge queue tmp branches
    branches-ignore:
    - "gh-readonly-queue/**"
  pull_request: # Run CI for PRs on any branch
  merge_group: # Run CI for the GitHub merge queue

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
# If you add additional jobs, remember to add them to bors.toml
permissions:
  contents: read
  actions: write

jobs:
  test-strategy:
    runs-on: ubuntu-latest

    outputs:
      treadmill-job-ids: ${{ steps.treadmill-job-launch.outputs.treadmill-job-ids }}

    steps:
      - name: Checkout the revision to analyze
        uses: actions/checkout@v3

      - name: Analyze changes and determine types of tests to run
        run: |
          echo "Hello World"

      - name: Generate a token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.TREADMILL_GH_APP_CLIENT_ID }}
          private-key: ${{ secrets.TREADMILL_GH_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Create JIT runner
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/treadmill-tb/tock/actions/runners/generate-jitconfig \
            -f "name=sometreadmillrunner2" \
            -F "runner_group_id=1" \
            -f "labels[]=self-hosted" \
            -f "labels[]=X64" \
            -f "labels[]=Linux" \
            -f "work_folder=_work"

      - name: Launch Treadmill CI Jobs
        id: treadmill-job-launch
        run: |
          echo "change3"
          echo 'treadmill-job-ids=["cc627a0b-8c8d-4edc-8394-5bdeedcee60c", "e80dfe6c-1a13-4653-a3b2-e01aafdb990d"]' >> "$GITHUB_OUTPUT"

  # test-execute:
  #   needs: test-strategy

  #   strategy:
  #     matrix:
  #       treadmill-job-id: ${{ fromJSON(needs.test-strategy.outputs.treadmill-job-ids) }}

  #   runs-on: tml-ghactions-runner-${{ matrix.treadmill-job-id }}

  #   steps:
  #     - name: Print Treadmill Job Id
  #       run: |
  #         echo ${{ matrix.treadmill-job-id }}
