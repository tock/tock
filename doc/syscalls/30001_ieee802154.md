---
driver number: 0x30001
---

# IEEE 802.15.4

## Overview

Tock exposes two userland interfaces that share driver number `0x30001`:

1. **Standard (MAC) interface** (`capsules/extra/src/ieee802154/driver.rs`)
   - Uses the in-kernel 802.15.4 stack to build headers, handle security, and
     multiplex access across multiple processes.
   - Userland provides payloads plus metadata; the kernel prepares frames and
     handles encryption/MIC when requested.
   - Supports neighbor and key management for link-layer security.

2. **PHY (raw) interface** (`capsules/extra/src/ieee802154/phy_driver.rs`)
   - Exposes the radio directly with minimal framing support.
   - Userland provides full 802.15.4 frames (PSDU without the FCS/CRC bytes).
   - Intended for single-process access or custom stacks that want complete
     control over framing and radio parameters.

These two interfaces map to the libtock-rs 802.15.4 examples: the standard
interface is appropriate for applications that want to send payloads while
relying on the kernel for 802.15.4 framing/security, whereas the PHY interface
is meant for examples that demonstrate raw 802.15.4 communication and direct
radio control.

## Allow

### Standard (MAC) interface

  * Description: `allow()` is used to share buffers with the kernel.

  * ### Read-Only Allow Number: 0

    **Description**: Write buffer containing the payload to transmit. The kernel
    appends the payload to the constructed 802.15.4 frame.

    **Argument 1**: Slice containing the payload.

    **Returns**: `Ok(())`.

  * ### Read-Write Allow Number: 0

    **Description**: Read ring buffer for received frames. The ring buffer format
    is:

    ```text
    | read index | write index | user_frame 0 | user_frame 1 | ... | user_frame n |
    ```

    Each `user_frame` stores three metadata bytes followed by the 802.15.4 frame:

    ```text
    | header_len | payload_len | mic_len | 15.4 frame |
    ```

    **Argument 1**: Slice for the ring buffer (must be sized as
    `2 + n * (3 + MAX_FRAME_SIZE)`).

    **Returns**: `Ok(())`.

  * ### Read-Write Allow Number: 1

    **Description**: Config buffer used by specific commands to pass additional
    parameters or return data. The required size depends on the command.

    **Argument 1**: Slice for command-specific configuration data.

    **Returns**: `Ok(())`.

### PHY (raw) interface

  * Description: `allow()` is used to share buffers with the kernel.

  * ### Read-Only Allow Number: 0

    **Description**: Write buffer containing the raw 802.15.4 frame (PSDU without
    FCS/CRC). The buffer length must match the frame length.

    **Argument 1**: Slice containing the frame bytes.

    **Returns**: `Ok(())`.

  * ### Read-Write Allow Number: 0

    **Description**: Read ring buffer for received frames, with the same format
    as the standard interface. The PHY driver sets `header_len` and `mic_len` to
    `0` because it does not parse or secure frames.

    **Argument 1**: Slice for the ring buffer.

    **Returns**: `Ok(())`.

## Subscribe

Both interfaces use the same subscribe numbers:

  * ### Subscribe Number: 0

    **Description**: Callback when a frame is received.

    **Argument 1**: LQI (link quality indicator).

    **Argument 2**: Unused.

    **Argument 3**: Unused.

    **Returns**: `Ok(())`.

  * ### Subscribe Number: 1

    **Description**: Callback when a frame transmission completes.

    **Argument 1**: Status code (success or error).

    **Argument 2**: `acked` flag (0/1) indicating whether the frame was acked.

    **Argument 3**: Unused.

    **Returns**: `Ok(())`.

## Command

### Standard (MAC) interface commands

  * ### Command Number: 0

    **Description**: Existence check.

    **Returns**: `Ok(())`.

  * ### Command Number: 1

    **Description**: Return radio status (`Ok(())` if on, `OFF` if off).

  * ### Command Number: 2

    **Description**: Set short address.

    **Argument 1**: Short address.

  * ### Command Number: 3

    **Description**: Set long address.

    **Argument 1**: Unused.

    **Argument 2**: Unused.

    **Argument 3**: `app_cfg` must be 8 bytes containing the long address.

  * ### Command Number: 4

    **Description**: Set PAN ID.

    **Argument 1**: PAN ID.

  * ### Command Number: 5

    **Description**: Set channel (not supported; returns `NOSUPPORT`).

  * ### Command Number: 6

    **Description**: Set transmission power (not supported; returns `NOSUPPORT`).

  * ### Command Number: 7

    **Description**: Commit configuration changes.

  * ### Command Number: 8

    **Description**: Get short address.

    **Returns**: `SuccessWithValue` (address + 1).

  * ### Command Number: 9

    **Description**: Get long address.

    **Argument 3**: `app_cfg` must be 8 bytes to receive the long address.

  * ### Command Number: 10

    **Description**: Get PAN ID.

    **Returns**: `SuccessWithValue` (PAN + 1).

  * ### Command Number: 11

    **Description**: Get channel (not supported; returns `NOSUPPORT`).

  * ### Command Number: 12

    **Description**: Get transmission power (not supported; returns `NOSUPPORT`).

  * ### Command Number: 13

    **Description**: Get maximum number of neighbors.

    **Returns**: `SuccessWithValue` (max + 1).

  * ### Command Number: 14

    **Description**: Get current number of neighbors.

    **Returns**: `SuccessWithValue` (count + 1).

  * ### Command Number: 15

    **Description**: Get short address of neighbor at index.

    **Argument 1**: Neighbor index.

    **Returns**: `SuccessWithValue` (short address + 1).

  * ### Command Number: 16

    **Description**: Get long address of neighbor at index.

    **Argument 1**: Neighbor index.

    **Argument 3**: `app_cfg` must be 8 bytes to receive the long address.

  * ### Command Number: 17

    **Description**: Add neighbor.

    **Argument 1**: Short address.

    **Argument 3**: `app_cfg` must be 8 bytes containing the long address.

    **Returns**: `SuccessWithValue` (neighbor index + 1).

  * ### Command Number: 18

    **Description**: Remove neighbor.

    **Argument 1**: Neighbor index.

  * ### Command Number: 19

    **Description**: Get maximum number of keys.

    **Returns**: `SuccessWithValue` (max + 1).

  * ### Command Number: 20

    **Description**: Get current number of keys.

    **Returns**: `SuccessWithValue` (count + 1).

  * ### Command Number: 21

    **Description**: Get security level of key at index.

    **Argument 1**: Key index.

    **Returns**: `SuccessWithValue` (security level + 1).

  * ### Command Number: 22

    **Description**: Get key ID of key at index.

    **Argument 1**: Key index.

    **Argument 3**: `app_cfg` must be 10 bytes; returns key ID mode + key ID.

  * ### Command Number: 23

    **Description**: Get key material at index.

    **Argument 1**: Key index.

    **Argument 3**: `app_cfg` must be 16 bytes to receive the key.

  * ### Command Number: 24

    **Description**: Add key.

    **Argument 3**: `app_cfg` must be 27 bytes:
      - 1 byte security level
      - 1 byte key ID mode
      - up to 9 bytes key ID (depending on mode)
      - 16 bytes key material

    **Returns**: `SuccessWithValue` (key index + 1).

  * ### Command Number: 25

    **Description**: Remove key.

    **Argument 1**: Key index.

  * ### Command Number: 26

    **Description**: Transmit a frame using the in-kernel parser/framer.

    **Argument 1**: Destination short address.

    **Argument 3**: `app_cfg` must be 11 bytes:
      - 1 byte security level
      - 10 bytes key ID encoding (mode + key ID)

    **Returns**: `Ok(())` if queued or immediate success; errors include `BUSY`
    if a transmission is already pending or `INVAL` for bad buffers/parameters.

  * ### Command Number: 28

    **Description**: Set long address using two 32-bit words.

    **Argument 1**: Lower 32 bits.

    **Argument 2**: Upper 32 bits.

  * ### Command Number: 29

    **Description**: Get long address as a 64-bit value.

    **Returns**: `SuccessWithValue64`.

  * ### Command Number: 30

    **Description**: Turn the radio on.

### PHY (raw) interface commands

  * ### Command Number: 0

    **Description**: Existence check.

  * ### Command Number: 1

    **Description**: Return radio status (`Ok(())` if on, `OFF` if off).

  * ### Command Number: 2

    **Description**: Set short address.

    **Argument 1**: Short address.

  * ### Command Number: 4

    **Description**: Set PAN ID.

    **Argument 1**: PAN ID.

  * ### Command Number: 5

    **Description**: Set channel.

    **Argument 1**: Channel number.

  * ### Command Number: 6

    **Description**: Set transmission power.

    **Argument 1**: Signed power value.

  * ### Command Number: 7

    **Description**: Commit configuration changes.

  * ### Command Number: 8

    **Description**: Get short address.

    **Returns**: `SuccessWithValue` (address + 1).

  * ### Command Number: 10

    **Description**: Get PAN ID.

    **Returns**: `SuccessWithValue` (PAN + 1).

  * ### Command Number: 11

    **Description**: Get channel.

    **Returns**: `SuccessWithValue` (channel number).

  * ### Command Number: 12

    **Description**: Get transmission power.

    **Returns**: `SuccessWithValue` (power value).

  * ### Command Number: 27

    **Description**: Transmit a raw frame. The write buffer must contain the
    PSDU without the FCS/CRC bytes.

  * ### Command Number: 28

    **Description**: Set long address using two 32-bit words.

    **Argument 1**: Lower 32 bits.

    **Argument 2**: Upper 32 bits.

  * ### Command Number: 29

    **Description**: Get long address as a 64-bit value.

    **Returns**: `SuccessWithValue64`.

  * ### Command Number: 30

    **Description**: Turn the radio on.

  * ### Command Number: 31

    **Description**: Turn the radio off.
