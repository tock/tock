LiteX SoC on the Digilent Arty-A7 FPGA Board
============================================

This board is targeting a SoC bitstream built using
[LiteX](https://github.com/enjoy-digital/litex), for the [Digilent
Arty-A7 FPGA
board](https://reference.digilentinc.com/reference/programmable-logic/arty-a7/start).

Since LiteX is a SoC builder, the individual generated bitstreams can
differ significantly depending on the LiteX release and configuration
options used. This board definition currently targets and has been
tested with
- [the LiteX SoC generator, revision
  444a605dea](https://github.com/enjoy-digital/litex/tree/444a605deae6a561dbe2c49bf3062eae6f3cd887)
- using the included [target
  file](https://github.com/enjoy-digital/litex/blob/444a605deae6a561dbe2c49bf3062eae6f3cd887/litex/boards/targets/arty.py)
- built around a VexRiscv-CPU
- along with the folling configuration options:

  ```
  --uart-baudrate=1000000
  --cpu-variant=full
  --csr-data-width=32
  --timer-uptime
  --integrated-rom-size=0xb000
  --with-ethernet
  ```

Many bitstream customizations can be represented in the Tock board by
simply changing the variables in `src/litex_generated.rs`. To support
a different set of FPGA cores and perform further modifications, the
`src/main.rs` file will have to be modified.


Warning
-------

This board is still in development. The memory protection (PMP)
mechanism is not yet integrated into the VexRiscv core and more
peripherals require drivers. Nonetheless, the Tock kernel works and
can run multiple userspace applications.

The following on-board components and cores are supported:
- [X] Timer (with uptime support)
- [X] UART output via USB-FTDI
- [X] Green LEDs
- [X] 100MBit/s Ethernet MAC

The following components and cores require porting:
- [ ] Compressed instruction support in the VexRiscv CPU
- [ ] Memory protection (PMP) support in the VexRiscv CPU ([upstream
      PR](https://github.com/SpinalHDL/VexRiscv/pull/147))
- [ ] GPIO Interface
- [ ] Buttons and Switches
- [ ] SPI


Building the SoC / Programming the FPGA
---------------------------------------

Please refer to the [LiteX
documentation](https://github.com/enjoy-digital/litex/wiki/) for
instructions on how to install and use the LiteX SoC generator.

Once LiteX and Xilinx Vivado is installed, building a bitstream should
be as simple as:

```
$ cd $PATH_TO_LITEX/litex/boards/targets
$ ./arty.py <configuration options> --build
```

This will produce a folder `build/arty/gateware` containing the
generated bitstream for the FPGA (`arty.bin`).

In addition to that, a folder `build/arty/software` will be included
containing support code and the SoC bios stored in ROM. The individual
SoC configuration options, interrupt assignments, register (LiteX
configuration status registers) addresses, etc. relevant for Tock can
be found in
`build/arty/software/include/generated/{csr.h,regions.ld,soc.h}`.

The bitstream can be programmed either by using Xilinx Vivado or running:

```
$ ./arty.py <configuration options> --load
```

To persistently write the bitstream to the included SPI flash, use the
Xilinx Vivado tools as outlined in [this
manual](https://reference.digilentinc.com/learn/programmable-logic/tutorials/arty-programming-guide/start#programming_the_arty_using_quad_spi). The
SPI flash used on the board may deviate from the manual, the part
number to select in Xilinx Vivado will be written on the SPI flash
chip.


Programming
-----------

By default, the LiteX SoC will feature an integrated BIOS in ROM,
which acts as a bootloader. The Tock kernel binary can be loaded
either using `litex_term.py` (available as `lxterm`) via serial, or
using TFTP via Ethernet. The uploaded image will be placed into the
`main_ram` section and executed.

If applications are inserted into the Tock image, it can grow to a
significant size which makes upload via serial slow. Using TFTP is
preferable.

To make a binary bootable via TFTP, assign the PC the address
`192.168.1.100/24` on the desired interface and make the kernel image
available as `boot.bin` on your TFTP server:

```
$ cp $PATH_TO_TOCK/target/riscv32i-unknown-none-elf/release/litex_arty.bin \
    /srv/tftp/boot.bin
```

Make sure that the tftp server is running and the firewall is
configured correctly.


Debugging
---------

LiteX makes it easy to generate vastly different SoCs. Prior to
creating an issue on GitHub, please verify that all variables in
`src/litex_generated.rs` correspond to the values provided to LiteX or
generated by it. The respective file paths for the source of each
value is included as a comment.

It is possible to extend the VexRiscv-CPU with a debug port, which is
exposed on the Wishbone bus of the SoC. This can then be used to
attach a GDB debugger via the Network using the Etherbone
(`--with-etherbone`) core. For more information refer to the LiteX
documentation and [this quickstart
guide](https://github.com/timvideos/litex-buildenv/wiki/Debugging).
